#!/bin/bash

export ROOT=$(echo $ROOT | grep . || pwd)
export NCORES=`nproc --all`

while getopts ":h" opt; do
  case ${opt} in
    h ) echo "Usage: ./BuildLinuxDeb.sh"
        echo "   Packages the built artifacts into a .deb"
        exit 0
        ;;
  esac
done

echo -n "[9/9] Generating Linux deb package..."

# Prepare staging directories
PKG_NAME_LOWER=$(echo "@SLIC3R_APP_NAME@" | tr '[:upper:]' '[:lower:]')

# Detect target Debian architecture: prefer dpkg, fallback to uname -m
ARCH_RAW=$(uname -m)
if command -v dpkg >/dev/null 2>&1; then
  ARCH_DPKG=$(dpkg --print-architecture 2>/dev/null || echo "")
else
  ARCH_DPKG=""
fi
case "${ARCH_DPKG:-$ARCH_RAW}" in
  x86_64|amd64) ARCH=amd64;;
  aarch64|arm64) ARCH=arm64;;
  loongarch64|loongarch) ARCH=loongarch64;;
  riscv64) ARCH=riscv64;;
  *) ARCH=$ARCH_DPKG; if [ -z "$ARCH" ]; then ARCH=amd64; fi;;
esac

DEB_ROOT="deb_root"
APP_DIR="opt/@SLIC3R_APP_NAME@"
BIN_DIR="$APP_DIR/bin"
RES_DIR="$APP_DIR/resources"
USR_BIN="usr/bin"
USR_SHARE_APPS="usr/share/applications"
USR_ICONS="usr/share/icons/hicolor"

rm -rf "$DEB_ROOT" 2>/dev/null
mkdir -p "$DEB_ROOT/DEBIAN" \
         "$DEB_ROOT/$BIN_DIR" \
         "$DEB_ROOT/$RES_DIR" \
         "$DEB_ROOT/$USR_BIN" \
         "$DEB_ROOT/$USR_SHARE_APPS" \
         "$DEB_ROOT/$USR_ICONS/32x32/apps" \
         "$DEB_ROOT/$USR_ICONS/128x128/apps" \
         "$DEB_ROOT/$USR_ICONS/192x192/apps"

# Copy resources (contents, not the folder itself) and binary
mkdir -p "$DEB_ROOT/$RES_DIR"
cp -a ../resources/. "$DEB_ROOT/$RES_DIR/"
cp -f src/@SLIC3R_APP_CMD@ "$DEB_ROOT/$BIN_DIR/@SLIC3R_APP_CMD@"

# Wrapper in /usr/bin
cat << EOF > "$DEB_ROOT/$USR_BIN/@SLIC3R_APP_CMD@"
#!/bin/bash
export LC_ALL=C
exec "/$BIN_DIR/@SLIC3R_APP_CMD@" "\$@"
EOF
chmod 755 "$DEB_ROOT/$USR_BIN/@SLIC3R_APP_CMD@"

# Desktop file
if [ -f "../src/platform/unix/CrealityPrint.desktop" ]; then
  cp "../src/platform/unix/CrealityPrint.desktop" "$DEB_ROOT/$USR_SHARE_APPS/@SLIC3R_APP_NAME@.desktop"
  # Use absolute Exec path to improve desktop integration across environments
  sed -i "s#Exec=.*#Exec=/usr/bin/@SLIC3R_APP_CMD@#" "$DEB_ROOT/$USR_SHARE_APPS/@SLIC3R_APP_NAME@.desktop"
  sed -i "s#Icon=.*#Icon=@SLIC3R_APP_NAME@#" "$DEB_ROOT/$USR_SHARE_APPS/@SLIC3R_APP_NAME@.desktop"
  chmod 644 "$DEB_ROOT/$USR_SHARE_APPS/@SLIC3R_APP_NAME@.desktop"
fi

# Icons
if [ -f "../resources/images/@SLIC3R_APP_NAME@_32px.png" ]; then
  cp ../resources/images/@SLIC3R_APP_NAME@_32px.png "$DEB_ROOT/$USR_ICONS/32x32/apps/@SLIC3R_APP_NAME@.png"
fi
if [ -f "../resources/images/@SLIC3R_APP_NAME@_128px.png" ]; then
  cp ../resources/images/@SLIC3R_APP_NAME@_128px.png "$DEB_ROOT/$USR_ICONS/128x128/apps/@SLIC3R_APP_NAME@.png"
fi
if [ -f "../resources/images/@SLIC3R_APP_NAME@_192px.png" ]; then
  cp ../resources/images/@SLIC3R_APP_NAME@_192px.png "$DEB_ROOT/$USR_ICONS/192x192/apps/@SLIC3R_APP_NAME@.png"
fi

# Control file
cat << EOF > "$DEB_ROOT/DEBIAN/control"
Package: $PKG_NAME_LOWER
Version: @CREALITYPRINT_VERSION@-@PROJECT_VERSION_EXTRA@
Section: utils
Priority: optional
Architecture: $ARCH
Maintainer: Creality <support@creality.com>
Depends: libc6, libstdc++6, libgtk-3-0, libx11-6, libgl1, libglu1-mesa, libpangocairo-1.0-0, libgdk-pixbuf2.0-0, libdbus-1-3
Description: @SLIC3R_APP_NAME@ 3D slicing application
 @SLIC3R_APP_NAME@ packaged for Debian-based systems.
EOF

# Post-install to update caches (optional)
cat << 'EOF' > "$DEB_ROOT/DEBIAN/postinst"
#!/bin/sh
set -e
if command -v update-desktop-database >/dev/null 2>&1; then
  update-desktop-database -q || true
fi
if command -v gtk-update-icon-cache >/dev/null 2>&1; then
  gtk-update-icon-cache -q /usr/share/icons/hicolor || true
fi
# Force menu/icon cache refresh for desktops that need it
if command -v xdg-desktop-menu >/dev/null 2>&1; then
  xdg-desktop-menu forceupdate || true
fi
exit 0
EOF
chmod 755 "$DEB_ROOT/DEBIAN/postinst"

DEB_NAME="@SLIC3R_APP_NAME@-V@CREALITYPRINT_VERSION@-@PROJECT_VERSION_EXTRA@-$ARCH.deb"
dpkg-deb --build "$DEB_ROOT" "$DEB_NAME"

echo "done"
